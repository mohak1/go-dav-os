name: Build

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ opened, synchronize ]

jobs:
  build-run:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write 

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build toolchain image (local)
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          tags: go-dav-os-toolchain:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build ISO
        run: |
          docker run --rm --platform=linux/amd64 \
            -v "$PWD":/work -w /work \
            go-dav-os-toolchain:ci \
            make -j$(nproc)

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: dav-go-os-iso
          path: build/dav-go-os.iso

      - name: Install QEMU
        run: sudo apt-get update && sudo apt-get install -y qemu-system-x86

      - name: Run Integration Tests
        run: python3 scripts/test_boot.py
